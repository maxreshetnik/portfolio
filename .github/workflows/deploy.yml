name: Deployment

on:
  push:
    branches: [ cicd ]

jobs:

  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.image_id.outputs.image_tag }}
      repo_name: ${{ steps.image_id.outputs.repo_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set output image name and tags
        id: image_id
        shell: bash
        run: |
          echo "::set-output name=image::${GITHUB_REPOSITORY}"
          echo "::set-output name=image_tag::${GITHUB_SHA::12}"
          echo "::set-output name=repo_name::${GITHUB_REPOSITORY#*/}"

      - name: Build and tag images
        run: >
          docker build --target prod 
          -t ${{ steps.image_id.outputs.image }}:${{ steps.image_id.outputs.image_tag }}
          -t ${{ steps.image_id.outputs.image }}:latest .

      - name: Push images to Docker Hub
        run: docker image push --all-tags ${{ steps.image_id.outputs.image }}

  deployment:
    needs: build
    if: ${{ success() }}
    runs-on: ubuntu-latest
    environment: production
    env:
      DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
      SSL_EMAIL: ${{ secrets.SSL_EMAIL }}
      DOCKER_HOST: "ssh://${{ secrets.SSH_HOST }}"
      STACK_NAME: ${{ needs.build.outputs.repo_name }}
      BACKEND_IMAGE: "${GITHUB_REPOSITORY}:${{ needs.build.outputs.image_tag }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Create ssh files
        shell: bash
        run: |
          mkdir -p $HOME/.ssh
          echo -en "${{ secrets.SSH_CONFIG }}" >> $HOME/.ssh/config
          echo -en "${{ secrets.SSH_KEY }}" > $HOME/.ssh/id_rsa
          echo "" >> $HOME/.ssh/known_hosts
          chmod -R 700 $HOME/.ssh
          ls -la $HOME/.ssh

      - name: Add server to ssh known_hosts
        shell: bash
        run: ssh-keyscan -H "${{ secrets.SSH_HOST_NAME }}" >> $HOME/.ssh/known_hosts

      - name: Ð¡heck docker on a server
        run: docker --host $DOCKER_HOST version

      - name: Deploy
        shell: bash
        run: >
          docker stack deploy --prune -c ./docker-compose.yml 
          -c ./docker-compose.stack.yml ${STACK_NAME}

      - name: Check on website
        shell: bash
        run: |
          echo "${BACKEND_IMAGE}"
          sleep 5m
          curl -f https://${DOMAIN_NAME}
